<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>BakÄ±rkÃ¶y Kuyumcusu - Premium AltÄ±n Paneli</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      background: #fafafa;
    }

    .flash-up {
      color: #16a34a !important;
      transform: scale(1.12);
      font-weight: 700;
      transition: all .22s ease-out;
    }
    .flash-down {
      color: #dc2626 !important;
      transform: scale(1.12);
      font-weight: 700;
      transition: all .22s ease-out;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal {
      background: white;
      padding: 22px;
      width: 330px;
      border-radius: 14px;
      box-shadow: 0 0 30px rgba(0,0,0,0.25);
      animation: pop .3s ease;
    }
    @keyframes pop {
      from { transform: scale(0.85); opacity: 0; }
      to   { transform: scale(1); opacity: 1; }
    }
  </style>
</head>

<body class="text-gray-800 antialiased">
  <div id="root"></div>

<script type="text/babel">

// =========================================================
// 1. Sabitler
// =========================================================

const API = "https://canlipiyasalar.haremaltin.com/tmp/altin.json?dil_kodu=tr";

// KENDÄ° DEÄžERLERÄ°NÄ° BURAYA YAZACAKSIN
const SUPA_URL = "https://vbohhfiyrldqwosoukxx.supabase.co";
const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZib2hoZml5cmxkcXdvc291a3h4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3MTQ1MTcsImV4cCI6MjA3OTI5MDUxN30.98w7JG6inltrNrW587Au1nSXsA5bKqhW3dBfUqbnNkg";

const supa = supabase.createClient(SUPA_URL, SUPA_KEY);


// =========================================================
// 2. YardÄ±mcÄ± Fonksiyonlar
// =========================================================

function fp(v) {
  return v?.toLocaleString("tr-TR") ?? "-";
}
function ft(t) {
  return t
    ? t.toLocaleTimeString("tr-TR", { hour: "2-digit", minute: "2-digit" })
    : "-";
}
function diff(c, p) {
  const d = c - p;
  const pct = (d / p) * 100;
  const s = d > 0 ? "+" : "";
  return `${s}${d.toFixed(2)} â‚º / ${s}${pct.toFixed(2)}%`;
}


// =========================================================
// 3. Component: AnimatedValue
// =========================================================

const AnimatedValue = ({ value, prev, showDiff = true }) => {
  if (value == null || isNaN(value)) return <span>-</span>;

  let cls = "text-xl font-bold transition-all duration-300 text-center";

  if (prev != null) {
    if (value > prev) cls += " flash-up";
    else if (value < prev) cls += " flash-down";
  }

  return (
    <div className="flex flex-col items-center leading-tight">
      <span className={cls}>
        {fp(value)} <span className="text-xs text-yellow-700">â‚º</span>
      </span>
      {showDiff && prev != null && (
        <span className="text-[11px] text-gray-500 mt-0.5">
          {diff(value, prev)}
        </span>
      )}
    </div>
  );
};


// =========================================================
// 4. Component: Fiyat SatÄ±rÄ±
// =========================================================

const Row = ({ title, buy, sell, prevBuy, prevSell }) => (
  <div className="py-4 flex justify-between items-center border-b border-gray-200">
    <div className="text-lg font-semibold">{title}</div>

    <div className="flex gap-8">
      <div>
        <div className="text-xs text-gray-400">AlÄ±ÅŸ</div>
        <AnimatedValue value={buy} prev={prevBuy} />
      </div>
      <div>
        <div className="text-xs text-yellow-700">SatÄ±ÅŸ</div>
        <AnimatedValue value={sell} prev={prevSell} />
      </div>
    </div>
  </div>
);


// =========================================================
// 5. Component: BÃ¼yÃ¼k Kutular (22 / 24)
// =========================================================

const Box = ({ title, value, prev }) => (
  <div
    className="bg-gray-50 rounded-lg p-3 text-center border border-gray-200"
    style={{
      minHeight: "90px",
      display: "flex",
      flexDirection: "column",
      justifyContent: "center",
    }}
  >
    <div className="text-sm text-gray-500 mb-1">{title}</div>
    <AnimatedValue value={value} prev={prev} />
  </div>
);


// =========================================================
// 6. Component: KÃ¼Ã§Ã¼k Kutular (0.25 / 0.5)
// =========================================================

const SmallBox = ({ title, value, prev }) => (
  <div className="bg-gray-50 rounded-lg p-2 text-center border border-gray-200">
    <div className="text-xs text-gray-400 mb-1">{title}</div>
    <AnimatedValue value={value} prev={prev} showDiff={false} />
  </div>
);


// =========================================================
// 7. Component: Login Modal
// =========================================================

function LoginModal({ onClose, onLoginSuccess }) {
  const [email, setEmail] = React.useState("");
  const [password, setPassword] = React.useState("");
  const [error, setError] = React.useState("");

  async function login() {
    const { data, error } = await supa.auth.signInWithPassword({
      email,
      password,
    });

    if (error) {
      setError(error.message);
      return;
    }

    onLoginSuccess(data.user);
  }

  return (
    <div className="modal-backdrop">
      <div className="modal">
        <h3 className="text-lg font-semibold mb-4 text-yellow-700">
          YÃ¶netici GiriÅŸi
        </h3>

        <input
          type="email"
          placeholder="E-posta"
          value={email}
          onChange={(e) => setEmail(e.target.value)}
          className="w-full px-3 py-2 mb-3 rounded-lg border border-gray-300 focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200 outline-none"
        />

        <input
          type="password"
          placeholder="Åžifre"
          value={password}
          onChange={(e) => setPassword(e.target.value)}
          className="w-full px-3 py-2 mb-3 rounded-lg border border-gray-300 focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200 outline-none"
        />

        {error && (
          <div className="text-red-600 text-xs mb-3">{error}</div>
        )}

        <div className="text-right">
          <button
            className="px-3 py-2 mr-2 border rounded"
            onClick={onClose}
          >
            Kapat
          </button>
          <button
            className="px-3 py-2 rounded bg-yellow-600 text-white"
            onClick={login}
          >
            GiriÅŸ Yap
          </button>
        </div>
      </div>
    </div>
  );
}


// =========================================================
// 8. Component: Admin Panel
// =========================================================

function AdminModal({ open, draft, setDraft, onClose, onSave }) {
  if (!open || !draft) return null;

  const fields = [
    ["ceyrek_alis", "Ã‡eyrek AlÄ±ÅŸ FarkÄ±"],
    ["ceyrek_satis", "Ã‡eyrek SatÄ±ÅŸ FarkÄ±"],
    ["ata_alis", "Ata AlÄ±ÅŸ FarkÄ±"],
    ["ata_satis", "Ata SatÄ±ÅŸ FarkÄ±"],
    ["gram22", "22 Ayar FarkÄ±"],
    ["gram24", "24 Ayar FarkÄ±"],
    ["g025", "0.25g Ã‡arpan"],
    ["g05_22", "0.50g (22K) Ã‡arpan"],
    ["g05_24", "0.50g (24K) Ã‡arpan"],
  ];

  return (
    <div className="modal-backdrop">
      <div className="modal">
        <h3 className="text-lg font-semibold mb-4 text-yellow-700">
          Fiyat PolitikasÄ±
        </h3>

        {fields.map(([key, label]) => (
          <div key={key} className="flex justify-between items-center mb-2">
            <span className="text-sm">{label}</span>
            <input
              type="number"
              value={draft[key]}
              onChange={(e) =>
                setDraft({ ...draft, [key]: Number(e.target.value) })
              }
              className="w-24 p-1 border rounded text-right"
            />
          </div>
        ))}

        <div className="text-right mt-4">
          <button className="px-3 py-2 mr-2 border rounded" onClick={onClose}>
            Kapat
          </button>
          <button
            className="px-3 py-2 rounded bg-yellow-600 text-white"
            onClick={onSave}
          >
            Kaydet
          </button>
        </div>
      </div>
    </div>
  );
}


// =========================================================
// 9. ANA UYGULAMA (APP)
// =========================================================

function App() {
  const [prices, setPrices] = React.useState({});
  const [prevPrices, setPrevPrices] = React.useState({});
  const [lastUpdate, setLastUpdate] = React.useState(null);
  const [countdown, setCountdown] = React.useState(3);

  const [user, setUser] = React.useState(null);
  const [loginOpen, setLoginOpen] = React.useState(false);

  const [policy, setPolicy] = React.useState(null);
  const [draft, setDraft] = React.useState(null);
  const [adminOpen, setAdminOpen] = React.useState(false);

  // SayaÃ§
  React.useEffect(() => {
    const t = setInterval(
      () => setCountdown((c) => (c <= 1 ? 3 : c - 1)),
      1000
    );
    return () => clearInterval(t);
  }, []);

  // PolitikayÄ± getir
  React.useEffect(() => {
    async function load() {
      const { data } = await supa
        .from("altin_politika")
        .select("*")
        .eq("id", 1)
        .single();
      setPolicy(data);
      setDraft(data);
    }
    load();
  }, []);

  // FÄ°YATLARI Ã‡EKEN EFEKT
React.useEffect(() => {
  if (!policy) return;

  // Her seferinde gÃ¼venli sayÄ± Ã§eviricisi
  const num = (v) => Number(v) || 0;

  async function load() {
    try {
      const r = await fetch(API);
      const j = await r.json();
      const d = j.data;

      const P = policy;

      // Ham fiyatlarÄ± gÃ¼venli sayÄ±ya Ã§evir
      const rawQuarterBuy  = num(d.CEYREK_ESKI.alis);
      const rawQuarterSell = num(d.CEYREK_ESKI.satis);
      const rawAtaBuy      = num(d.ATA_ESKI.alis);
      const rawAtaSell     = num(d.ATA_ESKI.satis);
      const rawG22Sell     = num(d.AYAR22.satis); // 22 ayar gram satÄ±ÅŸ
      const rawG24Sell     = num(d.ALTIN.satis);  // 24 ayar gram satÄ±ÅŸ

      // Politika makaslarÄ±nÄ± da SAYIYA Ã§evir
      const mkCeyrekAlis   = num(P.ceyrek_alis);
      const mkCeyrekSatis  = num(P.ceyrek_satis);
      const mkAtaAlis      = num(P.ata_alis);
      const mkAtaSatis     = num(P.ata_satis);
      const mkG22          = num(P.gram22);
      const mkG24          = num(P.gram24);

      const carp025        = num(P.g025);   // 0.25 Ã§arpan
      const carp05_22      = num(P.g05_22); // 0.50 22 Ã§arpan
      const carp05_24      = num(P.g05_24); // 0.50 24 Ã§arpan

      // Makas eklenmiÅŸ KESÄ°N TAM SAYI fiyatlar
      const qBuy  = Math.round(rawQuarterBuy  + mkCeyrekAlis);
      const qSell = Math.round(rawQuarterSell + mkCeyrekSatis);
      const aBuy  = Math.round(rawAtaBuy      + mkAtaAlis);
      const aSell = Math.round(rawAtaSell     + mkAtaSatis);

      const g22  = Math.round(rawG22Sell + mkG22);
      const g24  = Math.round(rawG24Sell + mkG24);

      // KÃ¼Ã§Ã¼k gramlar: makaslÄ± gram Ã¼zerinden hesapla
      const s025  = Math.round(g24 * carp025);
      const s0522 = Math.round(g22 * carp05_22);
      const s0524 = Math.round(g24 * carp05_24);

      const newPrices = {
        qBuy,  qSell,
        aBuy,  aSell,
        g22,   g24,
        s025,  s0522, s0524
      };

      setPrices((prev) => {
        setPrevPrices(prev || {});
        return newPrices;
      });

      setLastUpdate(new Date());
    } catch (e) {
      console.error("Fiyat Ã§ekme hatasÄ±:", e);
    }
  }

  load();
  const t = setInterval(load, 3000);
  return () => clearInterval(t);
}, [policy]);

  return (
    <div className="w-full max-w-2xl mx-auto px-4 pt-12 pb-10">
	<button
  className="fixed top-4 right-16 text-2xl text-gray-600 hover:text-black"
  onClick={() => window.open('ham.html', '_blank')}
  title="Ham Fiyatlar"
>
  ðŸ“œ
</button>


      {/* Ayar ikonu */}
      <button
        className="fixed top-4 right-4 text-2xl text-gray-600 hover:text-black"
        onClick={() => (user ? setAdminOpen(true) : setLoginOpen(true))}
      >
        âš™
      </button>

      {/* Ã‡Ä±kÄ±ÅŸ */}
      {user && (
        <button
          className="fixed top-4 left-4 text-sm text-red-600"
          onClick={async () => {
            await supa.auth.signOut();
            setUser(null);
          }}
        >
          Ã‡Ä±kÄ±ÅŸ Yap
        </button>
      )}

      {/* Logo */}
      <div className="flex justify-center mb-6">
        <img
          src="bk.jpeg"
          className="h-28 w-28 rounded-xl shadow-lg"
          alt="logo"
        />
      </div>

      {/* BaÅŸlÄ±k */}
      <h1 className="text-4xl font-serif font-bold text-center text-yellow-700 mb-1">
        BakÄ±rkÃ¶y Kuyumcusu
      </h1>

      <div className="text-center text-sm text-gray-500 mb-6">
        GÃ¼ncelleme: {ft(lastUpdate)} â€¢ {countdown}s
      </div>

      {/* Ana Kart */}
      <div className="bg-white p-6 rounded-2xl shadow-xl border">

        <Row
          title="Ã‡eyrek AltÄ±n"
          buy={prices.qBuy}
          sell={prices.qSell}
          prevBuy={prevPrices.qBuy}
          prevSell={prevPrices.qSell}
        />

        <Row
          title="Ata AltÄ±n"
          buy={prices.aBuy}
          sell={prices.aSell}
          prevBuy={prevPrices.aBuy}
          prevSell={prevPrices.aSell}
        />

        <div className="grid grid-cols-2 gap-4 mt-6">
          <Box title="22 Ayar Gram" value={prices.g22} prev={prevPrices.g22} />
          <Box title="24 Ayar Gram" value={prices.g24} prev={prevPrices.g24} />
        </div>

        <div className="grid grid-cols-3 gap-3 mt-4">
          <SmallBox title="0.25g (24K)" value={prices.s025} prev={prevPrices.s025} />
          <SmallBox title="0.50g (22K)" value={prices.s0522} prev={prevPrices.s0522} />
          <SmallBox title="0.50g (24K)" value={prices.s0524} prev={prevPrices.s0524} />
        </div>
      </div>

      {/* Login */}
      {loginOpen && (
        <LoginModal
          onClose={() => setLoginOpen(false)}
          onLoginSuccess={(u) => {
            setUser(u);
            setLoginOpen(false);
            setAdminOpen(true);
          }}
        />
      )}

      {/* Admin Panel */}
      {adminOpen && draft && (
        <AdminModal
          open={adminOpen}
          draft={draft}
          setDraft={setDraft}
          onClose={() => setAdminOpen(false)}
          onSave={async () => {
            await supa.from("altin_politika").update(draft).eq("id", 1);
            setPolicy({ ...draft });
            setAdminOpen(false);
          }}
        />
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);

</script>
</body>
</html>
